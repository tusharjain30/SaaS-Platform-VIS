// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Admin {
  id        Int      @id @default(autoincrement())
  userName  String?  @unique
  email     String   @unique
  phone     String   @unique
  name      String
  image     String?
  password  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Status Flags
  isActive   Boolean @default(true) // controls login access
  isDeleted  Boolean @default(false) // soft delete
  isVerified Boolean @default(false) // email/otp verified

  // Role Relation
  role   Role? @relation("AdminRole", fields: [roleId], references: [id])
  roleId Int?

  tokenVersion String @default(uuid())

  @@index([userName])
  @@index([isActive, isDeleted])
}

model Role {
  id   Int    @id @default(autoincrement())
  name String @unique

  permissions RolePermission[]
  Admin       Admin[]          @relation("AdminRole")
  users       User[]           @relation("UserRole")

  roleType  RoleType @default(INTERNAL_ADMIN)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  isDeleted Boolean  @default(false)
  isActive  Boolean  @default(true)

  @@index([isActive, isDeleted])
}

model Permission {
  id        Int              @id @default(autoincrement())
  name      String           @unique
  roles     RolePermission[]
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  isDeleted Boolean          @default(false)
  isActive  Boolean          @default(true)

  @@index([isActive, isDeleted])
}

model RolePermission {
  roleId       Int
  permissionId Int

  role       Role       @relation(fields: [roleId], references: [id])
  permission Permission @relation(fields: [permissionId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  isDeleted Boolean  @default(false)

  @@id([roleId, permissionId])
}

model User {
  id        Int      @id @default(autoincrement())
  name      String
  userName  String?  @unique
  email     String?  @unique
  phone     String   @unique
  password  String
  image     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // OTP for email/phone verification
  otp        String?
  otpExpires DateTime?

  // Status Flags
  isActive   Boolean @default(true)
  isDeleted  Boolean @default(false)
  isVerified Boolean @default(false)

  // API Tokens
  apiToken     String @default(uuid())
  tokenVersion String @default(uuid())

  // Relations
  role             Role?             @relation("UserRole", fields: [roleId], references: [id])
  roleId           Int?
  wabaVerification WabaVerification?
  templates        Template[]
  bots             Bot[]
  subscriptions    Subscription[]
  messageLogs      MessageLog[]
  accessTokens     AccessToken[]

  @@index([isActive, isDeleted])
}

model WabaVerification {
  id     Int  @id @default(autoincrement())
  user   User @relation(fields: [userId], references: [id])
  userId Int  @unique

  clientPhone String // phone number user wants to use
  otp         String?
  otpExpires  DateTime?
  status      VerificationStatus @default(PENDING)

  wabaPhoneId String? // your WABA phone_number_id used for verification
  wabaWabaId  String? // your WABA ID

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model MessageLog {
  id     Int  @id @default(autoincrement())
  user   User @relation(fields: [userId], references: [id])
  userId Int

  to           String // client sending to
  type         MessageType
  direction    MessageDirection @default(OUTBOUND)
  templateName String?
  payload      Json
  status       MessageStatus    @default(PENDING)

  createdAt DateTime @default(now())
}

model Template {
  id Int @id @default(autoincrement())

  // Relations
  user   User @relation(fields: [userId], references: [id])
  userId Int

  // Template Core
  name     String
  category TemplateCategory
  language String           @default("en_US")

  // Text content
  body      String
  variables Json?

  // Component-level fields (Flexible JSON)
  header     Json?
  footer     Json?
  buttons    Json?
  components Json?

  // Uploaded Media Files (image, document, video, location payload etc)
  mediaFiles Json?

  // Meta / info
  status         TemplateStatus @default(DRAFT)
  metaTemplateId String? // Meta ka template ID
  rejectReason   String? // Meta rejection reason

  // Flags
  isActive  Boolean @default(true)
  isDeleted Boolean @default(false)

  bots BotTemplate[]

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Prevent duplicate templates per user
  @@unique([userId, name, language])
  @@index([status, isActive, isDeleted])
}

model Bot {
  id     Int  @id @default(autoincrement())
  userId Int
  user   User @relation(fields: [userId], references: [id])

  name         String
  botType      BotType        @default(SIMPLE)
  triggerType  BotTriggerType
  triggerValue String?
  flow         Json? // bot steps JSON format

  replies BotReply[]

  isActive  Boolean @default(true)
  isDeleted Boolean @default(false)

  sessions  BotSession[]
  templates BotTemplate[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, botType, triggerType, isActive])
}

model BotReply {
  id Int @id @default(autoincrement())

  botId Int
  bot   Bot @relation(fields: [botId], references: [id])

  name String

  replyType BotReplyType @default(SIMPLE)

  // Trigger
  triggerType  BotTriggerType
  triggerValue String? // comma separated keywords / payload

  // Message
  bodyText   String?
  footerText String?

  // Interactive selector
  interactiveType InteractiveType?

  // Relations
  media       BotReplyMedia?
  buttons     BotReplyButton[]
  ctaButton   BotReplyCTA?
  listMessage BotReplyList?

  isActive  Boolean @default(true)
  isDeleted Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([botId, replyType, interactiveType, isActive])
}

model BotReplyMedia {
  id Int @id @default(autoincrement())

  replyId Int      @unique
  reply   BotReply @relation(fields: [replyId], references: [id])

  mediaType BotMediaType

  fileUrl     String?
  mimeType    String?
  metaMediaId String?

  createdAt DateTime @default(now())
}

model BotReplyButton {
  id Int @id @default(autoincrement())

  replyId Int
  reply   BotReply @relation(fields: [replyId], references: [id])

  label   String
  payload String? // keyword / next trigger
  order   Int

  createdAt DateTime @default(now())

  @@unique([replyId, order])
}

model BotReplyCTA {
  id Int @id @default(autoincrement())

  replyId Int      @unique
  reply   BotReply @relation(fields: [replyId], references: [id])

  displayText String
  url         String

  createdAt DateTime @default(now())
}

model BotReplyList {
  id Int @id @default(autoincrement())

  replyId Int      @unique
  reply   BotReply @relation(fields: [replyId], references: [id])

  buttonLabel String

  sections BotReplyListSection[]

  createdAt DateTime @default(now())
}

model BotReplyListSection {
  id Int @id @default(autoincrement())

  listId Int
  list   BotReplyList @relation(fields: [listId], references: [id])

  title String
  order Int

  rows BotReplyListRow[]

  createdAt DateTime @default(now())
}

model BotReplyListRow {
  id Int @id @default(autoincrement())

  sectionId Int
  section   BotReplyListSection @relation(fields: [sectionId], references: [id])

  title       String
  description String?
  rowId       String // WhatsApp sends this back
  order       Int

  createdAt DateTime @default(now())

  @@unique([sectionId, rowId])
}

model BotSession {
  id          Int            @id @default(autoincrement())
  userId      Int
  contact     String // customer phone
  botId       Int
  state       Json? // current node, variables
  triggerType BotTriggerType
  botType     BotType

  isActive    Boolean @default(true)
  isAIHandled Boolean @default(false)

  lastMessageAt DateTime  @default(now())
  expiresAt     DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  bot Bot @relation(fields: [botId], references: [id])

  @@unique([userId, contact, isActive])
}

model BotTemplate {
  id         Int @id @default(autoincrement())
  botId      Int
  templateId Int

  bot      Bot      @relation(fields: [botId], references: [id])
  template Template @relation(fields: [templateId], references: [id])

  createdAt DateTime @default(now())

  @@unique([botId, templateId])
}

model Plan {
  id Int @id @default(autoincrement())

  name        String  @unique
  description String?

  // Pricing
  price    Float // monthly price
  currency String @default("INR")

  // Template limits
  maxTemplates Int

  // Future services (keep extensible)
  maxBots             Int? // optional
  monthlyMessageLimit Int? // optional

  // Plan status
  isActive  Boolean @default(true)
  isDeleted Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  subscriptions Subscription[]

  @@index([isActive, isDeleted])
}

model Subscription {
  id Int @id @default(autoincrement())

  userId Int
  planId Int

  startDate DateTime  @default(now())
  endDate   DateTime?

  isActive Boolean @default(true)

  user User @relation(fields: [userId], references: [id])
  plan Plan @relation(fields: [planId], references: [id])

  @@index([userId, isActive])
}

model AccessToken {
  id     Int @id @default(autoincrement())
  userId Int

  tokenHash String // hash of the JWT
  service   ServiceType // TEMPLATE, BOT, MESSAGE etc

  limitValue Int? // e.g. max templates = 5
  usedValue  Int  @default(0) // optional, DB truth

  isActive Boolean @default(true)

  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId, service, isActive])
}

model Contact {
  id    Int    @id @default(autoincrement())
  phone String @unique

  firstName String?
  lastName  String?
  email     String?
  country   String?
  language  String?

  promotionalOptIn Boolean @default(true)
  aiEnabled        Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum TemplateCategory {
  MARKETING
  UTILITY
  AUTHENTICATION
}

enum TemplateStatus {
  DRAFT
  SUBMITTED
  APPROVED
  REJECTED
}

enum MessageType {
  TEXT
  TEMPLATE
  IMAGE
  VIDEO
  DOCUMENT
}

enum MessageStatus {
  PENDING
  SENT
  DELIVERED
  READ
  FAILED
}

enum VerificationStatus {
  PENDING
  VERIFIED
  FAILED
  EXPIRED
}

enum RoleType {
  SYSTEM_ADMIN // Super Admin
  INTERNAL_ADMIN // HR, Manager, Sub Admin, Support, etc.
  CUSTOMER_USER // Customer using your platform
}

enum ServiceType {
  TEMPLATE
  BOT
  MESSAGE
}

enum MessageDirection {
  INBOUND
  OUTBOUND
}

enum BotTriggerType {
  DEFAULT
  KEYWORD
  BUTTON
  WELCOME
  IS
  STARTS_WITH
  ENDS_WITH
  CONTAINS_WORD
  CONTAINS
  STOP_PROMOTIONAL
  START_PROMOTIONAL
  START_AI_BOT
  STOP_AI_BOT
}

enum BotReplyType {
  SIMPLE
  MEDIA
  INTERACTIVE
}

enum InteractiveType {
  REPLY_BUTTONS
  CTA_URL
  LIST
}

enum BotMediaType {
  IMAGE
  VIDEO
  DOCUMENT
  AUDIO
}

enum BotType {
  SIMPLE
  FLOW
  AI
}
